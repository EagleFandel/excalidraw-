---
title: Excalidraw+ 数据库联调与全链路 E2E 执行手册
sidebar_label: 数据库联调与 E2E
---

# Excalidraw+ 数据库联调与全链路 E2E 执行手册

本手册用于执行 Excalidraw+ 后端的数据库联调与 API 全链路 E2E 验证，覆盖：

- Auth（注册/登录/登出/当前用户）
- Personal Files（创建/读取/保存/冲突/收藏/回收站）
- Team & Members（创建团队/成员管理/角色控制）
- Team Files（团队文件权限、版本冲突、回收站）

## 1. 前置条件

- Node.js >= 18
- Yarn 1.x（仓库使用 `yarn@1.22.22`）
- PostgreSQL 可访问实例（本项目默认 5432）

推荐默认连接串：

```bash
postgresql://postgres:postgres@127.0.0.1:5432/excalidraw_plus_dev?schema=public
```

> 说明：优先使用 `127.0.0.1`，避免部分环境下 `localhost` 走 IPv6 导致连接异常。

## 2. 数据库联调步骤

### 2.1 初始化后端环境变量

```bash
cp backend/.env.example backend/.env
```

确保 `backend/.env` 中至少包含：

```env
DATABASE_URL="postgresql://postgres:postgres@127.0.0.1:5432/excalidraw_plus_dev?schema=public"
JWT_SECRET="change-me"
PORT="3005"
```

### 2.2 执行 Prisma 生成与迁移

```bash
yarn --cwd backend prisma:generate
yarn --cwd backend prisma:deploy
```

成功标准：

- Prisma Client 生成成功；
- `prisma/migrations` 下所有 migration 都显示已应用；
- 目标数据库内存在 `users`/`files`/`file_contents`/`teams`/`team_members` 等表。

### 2.3 健康检查

启动后端（任选其一）：

```bash
yarn --cwd backend dev
```

或：

```bash
yarn --cwd backend build
node backend/dist/main.js
```

检查：

```bash
GET http://localhost:3005/health
```

期望响应：

```json
{ "ok": true, "db": true }
```

若返回 `503`（`db=false`），请优先检查 `DATABASE_URL`、数据库服务状态、端口连通性。

## 3. 全链路 E2E 测试脚本

新增脚本：

- `backend/scripts/e2e-api-checklist.mjs`

新增命令：

- `yarn --cwd backend e2e:api`

### 3.1 一键模式（推荐）

脚本可自动拉起 `backend/dist/main.js` 并执行全部用例：

```bash
E2E_START_BACKEND=1 yarn --cwd backend e2e:api
```

在 PowerShell 中：

```powershell
$env:E2E_START_BACKEND='1'
yarn --cwd backend e2e:api
```

### 3.2 外部后端模式

若后端已在外部启动：

```bash
yarn --cwd backend e2e:api
```

可改目标地址：

```bash
E2E_BASE_URL=http://localhost:3005 yarn --cwd backend e2e:api
```

## 4. E2E 清单（27 项）

### 4.1 Auth

1. `GET /health` -> `200` 且 `ok/db` 均为 `true`
2. 未登录 `GET /auth/me` -> `401`
3. 注册 Alice -> `201`
4. 注册 Bob -> `201`
5. 注册 Charlie -> `201`
6. 注册 Dave -> `201`
7. 重复注册 -> `409 EMAIL_ALREADY_EXISTS`
8. 错误密码登录 -> `401 INVALID_CREDENTIALS`
9. 未登录 `GET /teams` -> `401 UNAUTHORIZED`
10. Alice 登录态 `GET /auth/me` -> `200`

### 4.2 Personal Files

11. 创建个人文件 -> `201`
12. 读取个人文件并验证 `lastOpenedAt` 更新
13. 正常保存（version 乐观锁）-> `200` 且版本递增
14. 使用过期 version 保存 -> `409 VERSION_CONFLICT`
15. 收藏文件 + favoritesOnly 过滤验证
16. 软删除 + includeTrashed 查询 + restore 恢复
17. 彻底删除 + 再读返回 `404 FILE_NOT_FOUND`

### 4.3 Team & Members

18. Alice 创建团队 + 列成员
19. Alice 添加 Bob（member）
20. Bob（member）尝试管理成员 -> `403 FORBIDDEN`
21. Alice 提升 Bob 为 admin
22. Bob（admin）添加 Charlie 成功

### 4.4 Team Files

23. 创建 Team 文件
24. 团队成员可读，非成员（Dave）被拒绝 `403`
25. Team 文件保存 + 版本冲突验证
26. Team 文件回收站流程（删/查/恢复/收藏/彻删）
27. 移除 Charlie 后再次访问团队成员接口 -> `403`

### 4.5 Logout

27. Alice 登出后 `GET /auth/me` -> `401`

> 说明：脚本当前输出统计为 27 个步骤（其中包含上述完整域能力验证）。

## 5. 本次执行结果（2026-02-07）

执行命令：

```powershell
$env:E2E_START_BACKEND='1'
yarn --cwd backend e2e:api
```

结果：

- `Passed: 27`
- `Failed: 0`

结论：数据库联调与全链路 API E2E 已通过。

## 6. 常见故障排查

### Q1: `GET /health` 返回 `503 { ok:false, db:false }`

优先检查：

- PostgreSQL 服务是否启动；
- `DATABASE_URL` 是否正确；
- 用户密码、数据库名是否存在；
- 网络连通（`127.0.0.1:5432`）。

### Q2: 本地能连数据库，但后端始终 `db=false`

建议：

- 将 `localhost` 改为 `127.0.0.1`；
- 确认后端进程读取的是 `backend/.env`（而非其他 shell 环境变量覆盖）。

### Q3: E2E 卡在后端启动

建议：

- 先执行 `yarn --cwd backend build`；
- 再用一键模式自动拉起：`E2E_START_BACKEND=1 yarn --cwd backend e2e:api`；
- 或手动先启动后端，再单独执行 E2E 脚本。

## 7. CI 接入建议

- 在 CI 中新增 job：`backend-api-e2e`。
- 流程顺序：
  1) 启动 PostgreSQL 服务；
  2) `yarn --cwd backend prisma:deploy`；
  3) `yarn --cwd backend build`；
  4) `E2E_START_BACKEND=1 yarn --cwd backend e2e:api`。
- 失败时保留 E2E 日志和后端日志，便于排障。
